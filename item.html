<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeoMovies Item</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0e14; color:#e6e6e6; }
    a { color: inherit; }
    header { padding:16px; border-bottom:1px solid #1b2230; }
    .wrap { max-width: 1000px; margin: 0 auto; }
    .back { text-decoration:none; color:#9aa4b2; font-size:13px; }
    main { padding: 18px 16px 40px; }
    .card { display:grid; grid-template-columns: 220px 1fr; gap:16px; }
    @media (max-width: 720px){ .card { grid-template-columns: 1fr; } }
    .poster { width:100%; border-radius:14px; border:1px solid #1b2230; object-fit:cover; aspect-ratio: 2/3; background:#0f1522; }
    h1 { margin:0; font-size:20px; }
    .meta { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:#9aa4b2; }
    .pill { border:1px solid #263144; padding:2px 8px; border-radius:999px; }
    .overview { margin-top:14px; line-height:1.45; color:#cbd5e1; white-space: pre-wrap; }
    .section { margin-top:16px; }
    .section h2 { margin:0 0 8px; font-size:14px; color:#9aa4b2; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="back" href="/">← Назад</a>
    </div>
  </header>
  <main>
    <div class="wrap">
      <div id="status" style="color:#9aa4b2; font-size:13px;">Загрузка…</div>
      <div id="content" style="display:none;">
        <div class="card">
          <img id="poster" class="poster" alt="" />
          <div>
            <h1 id="title"></h1>
            <div id="meta" class="meta"></div>
            <div id="overview" class="overview"></div>

            <div class="section" id="voicesWrap" style="display:none;">
              <h2>Озвучки</h2>
              <div id="voices" class="meta"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    const statusEl = document.getElementById('status');
    const contentEl = document.getElementById('content');

    function esc(s){return (s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

    function pill(text){
      const span = document.createElement('span');
      span.className = 'pill';
      span.textContent = text;
      return span;
    }

    async function load(){
      if (!id) {
        statusEl.textContent = 'Нет id';
        return;
      }
      try {
        const res = await fetch(`/api/library/item?kp_id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error('bad status');
        const it = await res.json();

        document.title = it.title || ('kp_' + it.kp_id);

        document.getElementById('poster').src = it.poster_url || '';
        document.getElementById('poster').alt = it.title || '';
        document.getElementById('title').textContent = it.title || ('kp_' + it.kp_id);
        document.getElementById('overview').textContent = it.overview || '';

        const meta = document.getElementById('meta');
        meta.innerHTML = '';
        if (it.type) meta.appendChild(pill(it.type));
        if (it.rating) meta.appendChild(pill('KP ' + Number(it.rating).toFixed(1)));
        if (Array.isArray(it.genres) && it.genres.length) meta.appendChild(pill(it.genres.join(', ')));
        if (it.type === 'series') {
          if (it.seasons_count) meta.appendChild(pill(it.seasons_count + ' сезон(ов)'));
          if (it.episodes_count) meta.appendChild(pill(it.episodes_count + ' серий'));
        }

        if (Array.isArray(it.voices) && it.voices.length) {
          const vw = document.getElementById('voicesWrap');
          const v = document.getElementById('voices');
          v.innerHTML = '';
          it.voices.forEach(x => v.appendChild(pill(x)));
          vw.style.display = '';
        }

        statusEl.style.display = 'none';
        contentEl.style.display = '';
      } catch (e) {
        statusEl.textContent = 'Ошибка загрузки';
      }
    }

    load();
  </script>
</body>
</html>
